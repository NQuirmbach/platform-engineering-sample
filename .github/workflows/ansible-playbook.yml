name: Configure Kubernetes Master Node

on:
  push:
    branches:
      - develop
      - main
  pull_request:
    branches:
      - develop
      - main

jobs:
  configure-master:
    runs-on: ubuntu-latest

    steps:
    # Schritt 1: Repository auschecken
    - name: Checkout repository
      uses: actions/checkout@v3

    # Schritt 2: Installiere Ansible
    - name: Install Ansible
      run: |
        sudo apt update
        sudo apt install -y ansible

    # Schritt 3: Setup SSH Key
    - name: Setup SSH key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
      shell: bash

    # Schritt 4: FÃ¼hre das Ansible-Playbook aus
    - name: Run Ansible Playbook
      working-directory: ops/ansible
      run: |
        inv_file="inventory/staging"
        if [ "${{ github.ref }}" == "refs/heads/main" ]; then
          inv_file="inventory/production"
        fi

        ansible-playbook -i "$inv_file" master-setup.yml
